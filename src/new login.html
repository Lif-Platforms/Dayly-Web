<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/login/main.css">
    <title>Lif | Login</title>
</head>
<body>
    <div class="context">
        <img src="Images/Lif-logo.png" style="width:20%; padding: 3%; margin-left:auto; margin-right:auto; display:block;">
        <br>
        <h1>Login</h1>
        <br>
        <br>
        <br>
        <form action="" id="#myForm">
            <input type="username" name="username" id="username" placeholder="Username" class="input"/>
            <br>
            <input type="password" name="password" id="password" placeholder="Password" class="input"/>
            <br>
            <input type="submit" value="Log In" id="login" class="button"/>
        </form>
        <br>
        <center><span id="login_status" style="color: red; text-align: center;"></span></center>
        <br>
        <br>
    </div>
    <div class="area" >
                <ul class="circles">
                        <li></li>
                        <li></li>
                        <li></li>
                        <li></li>
                        <li></li>
                        <li></li>
                        <li></li>
                        <li></li>
                        <li></li>
                        <li></li>
                </ul>
        </div >
        <script>
            window.onload = function() {
                var form = document.querySelector("form");
                form.onsubmit = submitted.bind(form);
            }
    
            function submitted(event) {
                event.preventDefault();
                document.getElementById("login").value = "Logging In...";
                document.getElementById("login").disabled = true;
                document.getElementById("username").disabled = true;
                document.getElementById("password").disabled = true;
                const socket = new WebSocket('ws://localhost:8000');
                
                try{
                    socket.addEventListener('open', function (event) {
    
                    socket.send('DAYLY_LOGIN');
                    console.log('Connection Established')
    
                    });
                }
                catch {
                    document.getElementById("login").value = "Log In";
                }
                
                var requestToken = false; 
    
                socket.addEventListener('message', function (event) {
    
                    console.log(event.data);
                    if (event.data === "USERNAME") {
                        var username = document.getElementById('username').value;
                        socket.send(username);
                    }
                    if (event.data === "PASSWORD") {
                        var password = document.getElementById('password').value;
                        socket.send(password);
                    }
                    if (event.data === "SUCCESS") {
                        document.getElementById("login").value = "Success!";
                        document.getElementById("login_status").innerHTML = "";
                        socket.send("TOKEN?");
                        requestToken = true; 
                    }
                    if (event.data === "INVALID_CREDENTIALS") {
                        document.getElementById("login").value = "Log In";
                        document.getElementById("login_status").innerHTML = "Username or password is incorrect!";
                        document.getElementById("login").disabled = false;
                        document.getElementById("username").disabled = false;
                        document.getElementById("password").disabled = false;
                    }
                    if (requestToken === true) {
                        var token = event.data;
                        localStorage.setItem("Lif_Token", token);
                        console.log(token);   
                        console.log("Retrieving Token...")
                        console.log(localStorage.getItem("Lif_Token"));
                        setTimeout(() => {  window.location.replace("C:/Users/btb5s/Desktop/Dayly Project/index.html"); }, 1000);
                    }
                });
    
                const contactServer = () => {
                    console.log("Initializing...")
                    socket.send("Initialize");
                }
            }
            
        </script>
    </body>
</html>